#Optimism in a sea of pessimism blog replication code
library(foreign)
library(haven)
library(Matching)
library(rgenoud)
library(survey)
library(psych)
library(haven)
library(descr)
library(ggeffects)

NDI19<-read_dta("NDI_2019_Nov_16.12.19_Public.dta")

names(NDI19)

table(as_factor(NDI19$SETTYPE))

table(as_factor(NDI19$SUBSTRATUM))
table(NDI19$SUBSTRATUM)

NDI19$SUBSTRATUM_r<-NDI19$SUBSTRATUM
NDI19$SUBSTRATUM_r[NDI19$SUBSTRATUM_r==10]<-1
NDI19$SUBSTRATUM_r[NDI19$SUBSTRATUM_r==51]<-2
NDI19$SUBSTRATUM_r[NDI19$SUBSTRATUM_r==52]<-3
NDI19$SUBSTRATUM_r[NDI19$SUBSTRATUM_r>=41]<-3
NDI19$SUBSTRATUM_r[NDI19$SUBSTRATUM_r>=11]<-2
table(NDI19$SUBSTRATUM_r)

NDI19$SUBSTRATUM_r<-as_factor(NDI19$SUBSTRATUM_r)

table(NDI19$RESPSEX)
NDI19$RESPSEX<-as_factor(NDI19$RESPSEX)

table(NDI19$RESPAGE)

table(as_factor(NDI19$RESPEDU))
NDI19$RESPEDU_r<-NDI19$RESPEDU
NDI19$RESPEDU_r[NDI19$RESPEDU_r<=-1]<-NA
NDI19$RESPEDU_r[NDI19$RESPEDU_r<=3]<-1
NDI19$RESPEDU_r[NDI19$RESPEDU_r==4]<-2
NDI19$RESPEDU_r[NDI19$RESPEDU_r>=5]<-3
NDI19$RESPEDU_r<-as_factor(NDI19$RESPEDU_r)

NDI19$OWNAIRC_r<-NDI19$OWNAIRC
NDI19$OWNAIRC_r[NDI19$OWNAIRC_r<=-1]<-NA
NDI19$OWNFRDG_r<-NDI19$OWNFRDG
NDI19$OWNFRDG_r[NDI19$OWNFRDG_r<=-1]<-NA
NDI19$OWNCOTV_r<-NDI19$OWNCOTV
NDI19$OWNCOTV_r[NDI19$OWNCOTV_r<=-1]<-NA
NDI19$OWNSPHN_r<-NDI19$OWNSPHN
NDI19$OWNSPHN_r[NDI19$OWNSPHN_r<=-1]<-NA
NDI19$OWNTBLT_r<-NDI19$OWNTBLT
NDI19$OWNTBLT_r[NDI19$OWNTBLT_r<=-1]<-NA
NDI19$OWNCARS_r<-NDI19$OWNCARS
NDI19$OWNCARS_r[NDI19$OWNCARS_r<=-1]<-NA
NDI19$OWNWASH_r<-NDI19$OWNWASH
NDI19$OWNWASH_r[NDI19$OWNWASH_r<=-1]<-NA
NDI19$OWNCOMP_r<-NDI19$OWNCOMP
NDI19$OWNCOMP_r[NDI19$OWNCOMP_r<=-1]<-NA
NDI19$OWNHWT_r<-NDI19$OWNHWT
NDI19$OWNHWT_r[NDI19$OWNHWT_r<=-1]<-NA
NDI19$OWNCHTG_r<-NDI19$OWNCHTG
NDI19$OWNCHTG_r[NDI19$OWNCHTG_r<=-1]<-NA

NDI19$wealth<-(NDI19$OWNAIRC_r+
    NDI19$OWNFRDG_r+
    NDI19$OWNCOTV_r+
    NDI19$OWNSPHN_r+
    NDI19$OWNTBLT_r+
    NDI19$OWNCARS_r+
    NDI19$OWNWASH_r+
    NDI19$OWNCOMP_r+
    NDI19$OWNHWT_r+
    NDI19$OWNCHTG_r)

table(as_factor(NDI19$POLDIRN))

NDI19$POLDIRN_r<-NDI19$POLDIRN
NDI19$POLDIRN_r[NDI19$POLDIRN_r<=-1]<-NA
NDI19$POLDIRN_r[NDI19$POLDIRN_r<=3]<-0
NDI19$POLDIRN_r[NDI19$POLDIRN_r>=4]<-1
table(as_factor(NDI19$DEMNOW))
NDI19$DEMNOW_r<-NDI19$DEMNOW
NDI19$DEMNOW_r[NDI19$DEMNOW_r<=-1]<-NA

freq(as_factor(NDI19$PARTYLIKE))
freq(as_factor(NDI19$PARTYSUPP1))
freq(as_factor(NDI19$PARTYSUPS))
freq(NDI19$PARTYSUPS)
table(NDI19$AB_GROUP, as_factor(NDI19$PARTYSUPP1))

NDI19$PARTYSUPP1_r<-(NDI19$PARTYSUPP1*10)
table(as_factor(NDI19$PARTYSUPP1))
table(as_factor(NDI19$PARTYSUPS))

NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==-40]<--4
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==-30]<-NA
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==-20]<--2
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==-10]<--1
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==10]<-4
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==20]<-9
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==30]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==40]<-6
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==50]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==60]<-2
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==70]<-3
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==80]<-1
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==90]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==100]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==110]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==120]<-5
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==130]<-8
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==140]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==150]<-7
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==160]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==170]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==180]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==190]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==200]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==210]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==220]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==230]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==240]<-10
NDI19$PARTYSUPP1_r[NDI19$PARTYSUPP1_r==250]<--5


NDI19$party_supp_combined<-ifelse(NDI19$PARTYSUPP1==-4, NDI19$PARTYSUPS, NDI19$PARTYSUPP1_r)
table(as_factor(NDI19$party_supp_combined))
freq(as_factor(NDI19$party_supp_combined), w = NDI19$WTIND)

NDI19$party_supp_combined_r<-NDI19$party_supp_combined
NDI19$party_supp_combined_r[NDI19$party_supp_combined_r>=5]<-5
NDI19$party_supp_combined_r<-as_factor(NDI19$party_supp_combined_r)
designNDI19 <- svydesign(id=~PSU,weights=~WTIND, strat=~SUBSTRATUM, data=NDI19)

model1<-svyglm(DEMNOW_r~wealth + RESPEDU_r + RESPSEX + RESPAGE + SUBSTRATUM_r, design = designNDI19, family = "binomial")
summary(model1)

plot(ggemmeans(model1, "RESPAGE[20, 40, 60]", data = designNDI19$variables))
plot(ggemmeans(model1, "SUBSTRATUM_r", data = designNDI19$variables))


model2<-svyglm(POLDIRN_r~wealth + RESPEDU_r + RESPSEX + RESPAGE + SUBSTRATUM_r, design = designNDI19, family = "binomial")
summary(model2)

plot(ggemmeans(model2, "RESPEDU_r", data = designNDI19$variables))
plot(ggemmeans(model2, "SUBSTRATUM_r", data = designNDI19$variables))

model3<-svyglm(DEMNOW_r~party_supp_combined_r+wealth + RESPEDU_r + RESPSEX + RESPAGE + SUBSTRATUM_r, design = designNDI19, family = "binomial")
summary(model3)

plot(ggemmeans(model3, "party_supp_combined_r", data = designNDI19$variables))
plot(ggemmeans(model3, "SUBSTRATUM_r", data = designNDI19$variables))


model4<-svyglm(POLDIRN_r~party_supp_combined_r+wealth + RESPEDU_r + RESPSEX + RESPAGE + SUBSTRATUM_r, design = designNDI19, family = "binomial")
summary(model4)

plot(ggemmeans(model4, "party_supp_combined_r", data = designNDI19$variables))


